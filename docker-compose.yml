services:
  # ===========================================
  # Mattermost Server
  # ===========================================
  mattermost:
    image: mattermost/mattermost-enterprise-edition:latest
    restart: unless-stopped
    environment:
      # Database configuration
      - MM_SQLSETTINGS_DRIVERNAME=postgres
      - MM_SQLSETTINGS_DATASOURCE=postgres://mattermost:mattermost@mattermost-db:5432/mattermost?sslmode=disable
      # Service settings
      - MM_SERVICESETTINGS_SITEURL=http://localhost:8066
      - MM_SERVICESETTINGS_ENABLELOCALMODE=true
      - MM_SERVICESETTINGS_LOCALMODESOCKETLOCATION=/var/tmp/mattermost_local.socket
      - MM_SERVICESETTINGS_ENABLEUSERACCESSTOKENS=true
      # Enable Shared Channels (required for Matrix bridge)
      - MM_EXPERIMENTALSETTINGS_ENABLESHAREDCHANNELS=true
      - MM_CONNECTEDWORKSPACESSETTINGS_ENABLESHAREDCHANNELS=true
      - MM_CONNECTEDWORKSPACESSETTINGS_ENABLEREMOTECLUSTERSERVICE=true
      # Plugin settings
      - MM_PLUGINSETTINGS_ENABLEUPLOADS=true
      - MM_PLUGINSETTINGS_AUTOMATICPREPACKAGEDPLUGINS=false
      # License settings - use trial license for shared channels
      - MM_TEAMSETTINGS_MAXUSERSPERTEAM=10000
    volumes:
      - mattermost-data:/mattermost/data
      - mattermost-logs:/mattermost/logs
      - mattermost-config:/mattermost/config
      - mattermost-plugins:/mattermost/plugins
      - mattermost-client-plugins:/mattermost/client/plugins
      - ./dist:/mattermost-plugin:ro
    ports:
      - "8066:8065"
    depends_on:
      mattermost-db:
        condition: service_healthy
    extra_hosts:
      - "host.docker.internal:host-gateway"

  mattermost-db:
    image: postgres:15-alpine
    restart: unless-stopped
    environment:
      - POSTGRES_USER=mattermost
      - POSTGRES_PASSWORD=mattermost
      - POSTGRES_DB=mattermost
    volumes:
      - mattermost-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mattermost"]
      interval: 5s
      timeout: 5s
      retries: 5

  # ===========================================
  # Matrix Synapse Server
  # ===========================================
  synapse-init:
    image: alpine:latest
    command: |
      sh -c "
        chown -R 991:991 /data
        chmod -R 755 /data
      "
    volumes:
      - synapse-data:/data

  synapse:
    image: matrixdotorg/synapse:latest
    restart: unless-stopped
    environment:
      - SYNAPSE_SERVER_NAME=localhost
      - SYNAPSE_REPORT_STATS=no
      - UID=991
      - GID=991
    volumes:
      - synapse-data:/data
      - ./docker/synapse_config.yaml:/data/homeserver.yaml:ro
      - ./docker/mattermost-bridge-registration.yaml:/data/mattermost-bridge-registration.yaml:ro
    ports:
      - "8888:8008"
      - "8448:8448"
    depends_on:
      - synapse-init
      - synapse-db
    extra_hosts:
      - "host.docker.internal:host-gateway"

  synapse-db:
    image: postgres:15-alpine
    restart: unless-stopped
    environment:
      - POSTGRES_DB=synapse
      - POSTGRES_USER=synapse
      - POSTGRES_PASSWORD=synapse
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=C --lc-ctype=C
    volumes:
      - synapse-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U synapse"]
      interval: 5s
      timeout: 5s
      retries: 5

  # ===========================================
  # Element Web Client (Optional - for testing Matrix)
  # ===========================================
  element-web:
    image: vectorim/element-web:latest
    restart: unless-stopped
    volumes:
      - ./docker/element-config.json:/app/config.json:ro
    ports:
      - "8080:80"
    depends_on:
      - synapse

volumes:
  synapse-data:
  synapse-db-data:
  mattermost-data:
  mattermost-logs:
  mattermost-config:
  mattermost-plugins:
  mattermost-client-plugins:
  mattermost-db-data:
