# E2E Testing Guide

## Quick Start

### 1. Start the Environment

```bash
./setup.sh
```

This will:
- Generate Synapse configuration
- Create registration file for the bridge
- Start all services (Mattermost, Synapse, Element, Bridge, Postgres)

### 2. Provision Mattermost

```bash
./provision_mm.sh
```

This script:
- Waits for Mattermost to be healthy
- Creates admin user (username: `sysadmin`, password: `Sys@dmin123`)
- Creates "Test Team" and "test-channel"
- Generates a Personal Access Token (PAT)
- Updates `config.yaml` with the PAT
- Restarts the bridge
- **Creates a Matrix test user** (username: `testuser`, password: `testpass123`)
- **Prepares the environment for automatic bridging**

### 3. Access Services

- **Mattermost**: http://localhost:8065
- **Element Web**: http://localhost:8080
- **Synapse**: http://localhost:8008

## Manual Testing

### Login to Mattermost
1. Navigate to http://localhost:8065
2. Login with:
   - Username: `sysadmin`
   - Password: `Sys@dmin123`

### Login to Element
1. Navigate to http://localhost:8080
2. Click "Create account"
3. Register a new user (homeserver is pre-configured to `http://localhost:8008`)

### Test Message Mirroring

**From Mattermost to Matrix:**
1. In Mattermost, navigate to "Test Team" â†’ "test-channel"
2. Send a message
3. Check if the message appears in the bridged Matrix room

**From Matrix to Mattermost:**
1. In Element, find the bridged room (should be `#mattermost_test-channel:localhost`)
2. Send a message
3. Check if it appears in Mattermost's "test-channel"

## Automated Browser Testing

```bash
# Install Playwright (if not already done)
python3 -m venv venv
./venv/bin/pip install playwright
./venv/bin/playwright install chromium

# Run the automated test
./venv/bin/python browser_test.py
```

## Troubleshooting

### Check Service Status
```bash
docker compose ps
```

### View Logs
```bash
# Bridge logs
docker logs mautrix-go-bridge-bridge-1

# Mattermost logs
docker logs mautrix-go-bridge-mattermost-1

# Synapse logs
docker logs mautrix-go-bridge-synapse-1
```

### Restart Services
```bash
docker compose restart
```

### Full Reset
```bash
docker compose down -v  # Remove volumes
rm -rf synapse-data config.yaml registration.yaml
./setup.sh
./provision_mm.sh
```

## Configuration Files

- `config.yaml` - Bridge configuration (auto-generated by setup.sh)
- `registration.yaml` - Appservice registration (auto-generated by setup.sh)
- `synapse-data/homeserver.yaml` - Synapse configuration
- `element-config.json` - Element Web configuration

## Notes

- The setup uses **Local Mode** for Mattermost, enabling `mmctl` automation
- The bridge runs as a Matrix Appservice
- All data persists in Docker volumes
- Port conflicts with existing services may prevent startup
